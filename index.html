<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FC360 | Performance Intelligence</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg-darkest: #080214;
            --bg-gradient-center: #1a0b3d;
            --bg-card: rgba(25, 15, 60, 0.8);
            --border-glow: rgba(138, 79, 255, 0.4);
            --accent-pink: #e942f5;
            --accent-cyan: #38bdf8;
            --accent-purple: #8a4fff;
            --accent-green: #4ade80;
            --text-light: #ffffff;
            --text-dim: #cbaefc;
            --font-main: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font-main);
            background: radial-gradient(circle at 50% 20%, var(--bg-gradient-center) 0%, var(--bg-darkest) 80%);
            background-color: var(--bg-darkest);
            color: var(--text-light);
            min-height: 100vh;
        }

        /* --- Components --- */
        .glass-card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-glow);
            box-shadow: inset 0 0 20px rgba(138, 79, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 2rem;
            transition: border-color 0.3s;
        }
        .glass-card:hover { border-color: var(--accent-pink); }

        input, select {
            width: 100%;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-glow);
            background-color: rgba(10, 4, 28, 0.6);
            color: var(--text-light);
            outline: none;
            margin-bottom: 1rem;
        }
        input:focus, select:focus { border-color: var(--accent-pink); }
        label { display: block; font-size: 0.75rem; color: var(--accent-cyan); font-weight: bold; text-transform: uppercase; margin-bottom: 0.5rem; margin-left: 0.25rem;}

        .btn-neon {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-pink));
            color: white;
            font-weight: bold;
            border-radius: 30px;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        .btn-neon:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 20px rgba(233, 66, 245, 0.4);
        }
        .btn-text { background: none; border: none; color: var(--text-dim); text-decoration: underline; cursor: pointer; font-size: 0.9rem; }
        
        /* --- Utilities --- */
        .view-section { display: none; }
        .view-section.active { display: block; animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .chart-container { position: relative; height: 400px; width: 100%; display: flex; justify-content: center; align-items: center; }
        
        #exportPdfBtn { transition: opacity 0.3s ease, transform 0.3s ease; }
        #exportPdfBtn.hidden-btn { opacity: 0; pointer-events: none; transform: translateY(20px); }
        #exportPdfBtn.visible-btn { opacity: 1; pointer-events: auto; transform: translateY(0); }
        
        .video-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 */
            height: 0;
            overflow: hidden;
            border-radius: 0 0 12px 12px;
            background: #000;
        }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        
        /* Custom Scrollbar for Insights */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); }
        ::-webkit-scrollbar-thumb { background: var(--border-glow); border-radius: 4px; }
    </style>
</head>
<body class="p-4 sm:p-8 relative">

    <nav class="flex justify-between items-center mb-8 py-4 border-b border-gray-800">
        <div class="text-2xl font-bold text-cyan-400 tracking-wider">FC360</div>
        <div id="userControls" class="hidden flex items-center gap-4">
            <div class="text-right hidden sm:block">
                <div id="navName" class="text-white font-bold text-sm"></div>
                <div id="navPos" class="text-dim text-xs"></div>
            </div>
            <button onclick="app.logout()" class="text-xs text-red-400 hover:text-white uppercase tracking-widest font-bold border border-red-400/30 px-3 py-2 rounded hover:bg-red-400/20 transition">Logout</button>
        </div>
    </nav>

    <section id="viewLogin" class="view-section active max-w-md mx-auto mt-20">
        <div class="glass-card text-center">
            <h2 class="text-3xl font-bold text-white mb-2">Member Login</h2>
            <p class="text-dim mb-8 text-sm">Sign in to access your intelligence reports.</p>
            
            <form onsubmit="app.login(event)">
                <div class="text-left">
                    <label>Email Address</label>
                    <input type="email" id="loginEmail" placeholder="player@example.com" required>
                </div>
                <div class="text-left">
                    <label>Password</label>
                    <input type="password" id="loginPass" placeholder="••••••••" required>
                </div>
                <button type="submit" id="loginBtn" class="btn-neon mb-4">Login</button>
                <button type="button" onclick="app.showSignup()" class="btn-text">Create an Account</button>
                <p id="loginError" class="text-red-400 text-sm mt-4 hidden"></p>
            </form>
        </div>
    </section>

    <section id="viewSignup" class="view-section max-w-md mx-auto mt-10">
        <div class="glass-card text-center">
            <h2 class="text-2xl font-bold text-white mb-2">Create Profile</h2>
            <p class="text-dim mb-6 text-sm">Join the FC360 platform.</p>
            
            <form onsubmit="app.signup(event)">
                <div class="text-left">
                    <label>Full Name</label>
                    <input type="text" id="regName" placeholder="John Doe" required>
                </div>
                <div class="text-left">
                    <label>Email Address</label>
                    <input type="email" id="regEmail" placeholder="john@example.com" required>
                </div>
                <div class="text-left">
                    <label>Password</label>
                    <input type="password" id="regPass" placeholder="Create a password" required>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="text-left">
                        <label>Phone</label>
                        <input type="tel" id="regPhone" placeholder="555-0123">
                    </div>
                    <div class="text-left">
                        <label>Position</label>
                        <select id="regPos" required>
                            <option value="Defender">Defender</option>
                            <option value="Midfielder">Midfielder</option>
                            <option value="Attacker">Attacker</option>
                            <option value="Goalkeeper">Goalkeeper</option>
                        </select>
                    </div>
                </div>
                <div class="text-left bg-gray-900/50 p-3 rounded border border-gray-700 mb-4">
                    <label class="text-yellow-400">Match Name (Important)</label>
                    <p class="text-xs text-gray-400 mb-2">How does your name appear in the game data? (e.g., "10. Messi")</p>
                    <input type="text" id="regMatchName" placeholder="e.g. 23. Jordan" required class="mb-0">
                </div>

                <button type="submit" id="regBtn" class="btn-neon mb-4">Create Account</button>
                <button type="button" onclick="app.showLogin()" class="btn-text">Back to Login</button>
                <p id="regError" class="text-red-400 text-sm mt-4 hidden"></p>
            </form>
        </div>
    </section>

    <section id="viewAdmin" class="view-section max-w-xl mx-auto mt-10">
        <div class="glass-card">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-white">Admin Data Upload</h2>
                <div class="flex gap-3">
                    <button onclick="app.goToDashboard()" class="text-xs text-cyan-400 border border-cyan-400/30 px-2 py-1 rounded hover:bg-cyan-400/20">View Dashboard</button>
                    <button onclick="app.logout()" class="text-xs text-red-400 hover:text-white">Logout</button>
                </div>
            </div>
            
            <div class="space-y-6">
                <div>
                    <label>YouTube Video ID</label>
                    <input type="text" id="adminVideoId" placeholder="e.g., dQw4w9WgXcQ" class="bg-gray-900 border-gray-700">
                    <p class="text-xs text-gray-500 mt-1">Found in the URL after 'v='</p>
                </div>

                <div class="p-8 border-2 border-dashed border-gray-600 rounded-lg bg-gray-900/50 text-center hover:border-cyan-500/50 transition-colors">
                    <label class="block cursor-pointer">
                        <span class="text-cyan-400 font-bold text-lg block mb-2">Select Sportscode XML</span>
                        <input type="file" id="adminFile" accept=".xml" class="hidden" onchange="app.handleFileSelect(this)">
                    </label>
                    <p id="fileNameDisplay" class="text-sm text-white font-mono bg-gray-800 py-2 px-4 rounded inline-block mt-2">No file selected</p>
                </div>
                <button id="uploadBtn" onclick="app.processAndUpload()" disabled class="btn-neon opacity-50 cursor-not-allowed">
                    Upload & Process Game
                </button>
            </div>
        </div>
    </section>

    <section id="viewDashboard" class="view-section max-w-6xl mx-auto">
        <div class="grid md:grid-cols-4 gap-6">
            <div class="md:col-span-1 space-y-6">
                <div class="glass-card p-4">
                    <h3 class="text-lg text-white mb-3">Your Matches</h3>
                    <select id="gameSelect" disabled onchange="app.loadGame(this.value)">
                        <option value="" disabled selected>No Games Found</option>
                    </select>
                </div>
                
                <div class="text-dim text-xs italic p-2 opacity-70 bg-gray-900/30 rounded border border-gray-800">
                    *Data is filtered based on your Match Name: <span id="displayMatchName" class="text-cyan-400 font-bold"></span>
                </div>
            </div>

            <div class="md:col-span-3">
                <div class="glass-card min-h-[600px]" id="snapshotContainer">
                    <div class="flex justify-between items-end border-b border-gray-700 pb-4 mb-6">
                        <div id="reportHeader">
                            <h2 class="text-3xl text-white font-bold" id="reportTitleText">Welcome</h2>
                            <p id="reportSubText" class="text-dim text-sm mt-1">Select a game to view analysis</p>
                        </div>
                        <div id="brandingText" class="text-xs text-gray-500">FC360 Intelligence</div>
                    </div>

                    <div id="dashboardContent" class="space-y-8">
                        <div class="flex flex-col items-center justify-center h-96 text-dim opacity-50">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                            </svg>
                            <p>Analytics Ready</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <button id="exportPdfBtn" onclick="app.exportPDF()" class="hidden-btn fixed bottom-8 right-8 text-white font-bold py-3 px-6 rounded-full shadow-lg flex items-center z-50 cursor-pointer hover:scale-105 transition-transform" style="background: var(--accent-cyan);">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
        </svg>
        Export Profile
    </button>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE CONFIG (Paste yours here) ---
        const firebaseConfig = {
            apiKey: "AIzaSyC9y_vQf5lK8OXWwvQlGGmF8yt0HJAE9io",
            authDomain: "fc360-beccb.firebaseapp.com",
            projectId: "fc360-beccb",
            storageBucket: "fc360-beccb.firebasestorage.app",
            messagingSenderId: "218674719680",
            appId: "1:218674719680:web:632b7f32d795c3a1b5f625"
        };
        // ------------------------------------------

        const appInit = initializeApp(firebaseConfig);
        const auth = getAuth(appInit);
        const db = getFirestore(appInit);

        let currentUser = null;
        let chartInstance = null;
        const state = { games: [] };

        // --- ! IMPORTANT ! SET YOUR ADMIN EMAIL HERE ---
        const ADMIN_EMAIL = "info@fc360.co"; 
        // ------------------------------------------------

        // Configuration
        const positionConfig = {
            'Defender': {
                labels: ['Recovery', 'Interception', 'Aerial Duel', 'Ground Duel'],
                map: { 'Recovery': ['Recovery', 'Counterpressing recovery'], 'Interception': ['Interception'], 'Aerial Duel': ['Aerial duel'], 'Ground Duel': ['Ground duel', 'Defensive duel'] }
            },
            'Midfielder': {
                labels: ['Passes', 'Total Duels', 'Progressive', 'Interception'],
                map: { 'Passes': ['Pass', 'Forward pass', 'Lateral pass'], 'Total Duels': ['Duel', 'Ground duel'], 'Progressive': ['Progressive pass'], 'Interception': ['Interception'] }
            },
            'Attacker': {
                labels: ['Goals', 'Box Touch', 'Shot', 'Opportunity'],
                map: { 'Goals': ['Goal'], 'Box Touch': ['Touch in box'], 'Shot': ['Shot'], 'Opportunity': ['Opportunity'] }
            },
            'Goalkeeper': {
                labels: ['Saves', 'Claims', 'Distribution', 'Sweeper'],
                map: { 'Saves': ['Save'], 'Claims': ['Claim'], 'Distribution': ['Pass', 'Goal kick'], 'Sweeper': ['Sweeper action'] }
            }
        };
        const NEGATIVE_LABELS = ['Loss', 'Dribbled past attempt', 'Offside', 'Conceded goal'];

        window.app = {
            // --- AUTH ---
            showSignup: () => switchView('viewSignup'),
            showLogin: () => switchView('viewLogin'),
            
            signup: async (e) => {
                e.preventDefault();
                const btn = document.getElementById('regBtn');
                const err = document.getElementById('regError');
                btn.disabled = true; btn.textContent = "Creating Account...";
                err.classList.add('hidden');

                const email = document.getElementById('regEmail').value;
                const pass = document.getElementById('regPass').value;
                const name = document.getElementById('regName').value;
                const phone = document.getElementById('regPhone').value;
                const pos = document.getElementById('regPos').value;
                const matchName = document.getElementById('regMatchName').value;

                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
                    await setDoc(doc(db, "users", userCredential.user.uid), {
                        fullName: name, email: email, phoneNumber: phone, position: pos, matchName: matchName,
                        createdAt: new Date().toISOString()
                    });
                    alert("Account Created! Please Login.");
                    switchView('viewLogin');
                } catch (error) {
                    err.textContent = error.message;
                    err.classList.remove('hidden');
                } finally {
                    btn.disabled = false; btn.textContent = "Create Account";
                }
            },

            login: async (e) => {
                e.preventDefault();
                const btn = document.getElementById('loginBtn');
                const err = document.getElementById('loginError');
                btn.disabled = true; btn.textContent = "Verifying...";
                err.classList.add('hidden');

                const email = document.getElementById('loginEmail').value;
                const pass = document.getElementById('loginPass').value;

                try {
                    const userCredential = await signInWithEmailAndPassword(auth, email, pass);
                    const uid = userCredential.user.uid;

                    // SMART ROUTING: Check if this is the Admin
                    if (userCredential.user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
                        currentUser = { fullName: "Admin", email: email, position: "Coach", matchName: "Admin", uid: uid, isAdmin: true };
                        alert("Welcome back, Coach.");
                        switchView('viewAdmin');
                    } else {
                        // Regular Player
                        const docSnap = await getDoc(doc(db, "users", uid));
                        if (docSnap.exists()) {
                            currentUser = docSnap.data();
                            currentUser.uid = uid;
                            currentUser.isAdmin = false;
                            initDashboard();
                        } else {
                            throw new Error("User profile missing.");
                        }
                    }
                } catch (error) {
                    err.textContent = "Login Failed: " + error.message;
                    err.classList.remove('hidden');
                } finally {
                    btn.disabled = false; btn.textContent = "Login";
                }
            },

            logout: () => {
                signOut(auth).then(() => { currentUser = null; switchView('viewLogin'); });
            },

            // --- ADMIN ---
            showAdmin: () => switchView('viewAdmin'), // In case they are logged in and want to go back
            
            goToDashboard: () => {
                // If Admin wants to see dashboard
                if(!currentUser) return;
                initDashboard();
            },

            handleFileSelect: (input) => {
                if(input.files[0]) {
                    document.getElementById('fileNameDisplay').textContent = input.files[0].name;
                    document.getElementById('uploadBtn').disabled = false;
                    document.getElementById('uploadBtn').classList.remove('opacity-50', 'cursor-not-allowed');
                }
            },

            processAndUpload: () => {
                const file = document.getElementById('adminFile').files[0];
                const videoId = document.getElementById('adminVideoId').value.trim();
                if(!file) return;
                
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const parser = new DOMParser();
                        const xml = parser.parseFromString(e.target.result, "text/xml");
                        const parsed = parseXML(xml);
                        const gameId = 'game_' + Date.now();
                        await setDoc(doc(db, 'artifacts', 'fc360-app', 'public', 'data', 'games', gameId), {
                            matchName: file.name.replace('.xml', ''),
                            videoId: videoId,
                            playerData: parsed.players,
                            playerList: parsed.playerNames,
                            uploadDate: new Date().toISOString()
                        });
                        alert("Game Uploaded successfully!");
                        document.getElementById('fileNameDisplay').textContent = "Upload Complete";
                    } catch(err) {
                        alert("Error: " + err.message);
                    }
                };
                reader.readAsText(file);
            },

            // --- DASHBOARD ---
            loadGame: (index) => {
                const game = state.games[index];
                if (!game || !currentUser) return;
                
                // If Admin, they might not match a name in the file.
                // We just default to the FIRST player in the list if no match found.
                const availablePlayers = Object.keys(game.data.playerData);
                
                let matchedKey;
                if(currentUser.isAdmin) {
                    // For Admin: Try to find a player from the dropdown if we had one, 
                    // or just pick the first one for preview. 
                    // Ideally admin selects a player, but for now we pick the first to avoid crash.
                    matchedKey = availablePlayers[0];
                    alert(`Admin Mode: Viewing data for ${matchedKey}`);
                } else {
                    matchedKey = availablePlayers.find(p => p.toLowerCase() === currentUser.matchName.toLowerCase());
                    if(!matchedKey) matchedKey = availablePlayers.find(p => p.toLowerCase().includes(currentUser.matchName.toLowerCase()));
                }

                if (!matchedKey) {
                    alert(`Could not find player "${currentUser.matchName}" in this game file.`);
                    return;
                }

                const playerData = game.data.playerData[matchedKey];
                const videoId = game.data.videoId || ''; 
                
                // Use user's position, or default to Midfielder if admin/unknown
                const pos = currentUser.position || 'Midfielder';
                
                renderRadarReport(matchedKey, pos, playerData, game.data.playerData, game.name, videoId);
            },

            exportPDF: () => {
                 const element = document.getElementById('snapshotContainer');
                 const originalBg = element.style.backgroundColor;
                 const originalOverflow = document.getElementById('dashboardContent').style.overflow;
                 document.body.style.cursor = 'wait';
                 document.getElementById('dashboardContent').style.overflow = 'visible';
                 element.style.backgroundColor = '#080214';
                 
                 const opt = {
                    margin: 0.1, filename: `FC360_Report.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true, backgroundColor: '#080214' },
                    jsPDF: { unit: 'in', format: 'letter', orientation: 'landscape' }
                };
                html2pdf().set(opt).from(element).save().then(() => {
                    element.style.backgroundColor = originalBg;
                    document.getElementById('dashboardContent').style.overflow = originalOverflow;
                    document.body.style.cursor = 'default';
                });
            }
        };

        // --- INTERNAL FUNCTIONS ---
        function switchView(id) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        async function initDashboard() {
            document.getElementById('navName').textContent = currentUser.fullName;
            document.getElementById('navPos').textContent = currentUser.position;
            document.getElementById('displayMatchName').textContent = currentUser.matchName;
            document.getElementById('userControls').classList.remove('hidden');
            switchView('viewDashboard');

            const select = document.getElementById('gameSelect');
            select.innerHTML = '<option>Searching matches...</option>';
            const q = collection(db, 'artifacts', 'fc360-app', 'public', 'data', 'games');
            const snapshot = await getDocs(q);
            state.games = [];

            snapshot.forEach(doc => {
                const d = doc.data();
                // If Admin, show ALL games. If Player, filter by name.
                if (currentUser.isAdmin) {
                    state.games.push({ id: doc.id, name: d.matchName, data: d });
                } else {
                    if (d.playerList.some(name => name.toLowerCase().includes(currentUser.matchName.toLowerCase()))) {
                        state.games.push({ id: doc.id, name: d.matchName, data: d });
                    }
                }
            });

            if (state.games.length === 0) {
                select.innerHTML = '<option>No matches found.</option>';
                select.disabled = true;
            } else {
                select.innerHTML = '<option value="" disabled selected>Select Match</option>';
                state.games.forEach((g, i) => {
                    const opt = document.createElement('option');
                    opt.value = i; opt.text = g.name;
                    select.appendChild(opt);
                });
                select.disabled = false;
            }
        }

        function parseXML(xmlDoc) {
            const instances = xmlDoc.querySelectorAll('instance');
            const players = {};
            instances.forEach(inst => {
                const code = inst.querySelector('code')?.textContent?.trim();
                if(!code) return;
                if(!players[code]) players[code] = { actions: {} };
                const labels = Array.from(inst.querySelectorAll('label text')).map(t => t.textContent.trim());
                let success = !labels.some(l => NEGATIVE_LABELS.includes(l));
                labels.forEach(l => {
                    if(l.startsWith('<flag>')) return;
                    if(!players[code].actions[l]) players[code].actions[l] = { total: 0, success: 0 };
                    players[code].actions[l].total++;
                    if(success) players[code].actions[l].success++;
                });
            });
            return { players, playerNames: Object.keys(players) };
        }

        function generateFeedback(metrics, position) {
            const sorted = [...metrics].sort((a, b) => b.pct - a.pct);
            const best = sorted[0];
            const worst = sorted[sorted.length - 1];

            const insights = [
                `Primary strength identified in <strong>${best.label}</strong> (${best.pct}% success).`,
                `Performance in ${worst.label} is currently below the optimal threshold.`,
                `High engagement detected in ${sorted[1].label} actions.`
            ];
            const nextSteps = [
                `Video Review: Analyze the failed attempts at <strong>${worst.label}</strong>.`,
                `Drill Recommendation: Small-sided games focusing on ${worst.label}.`,
                `Maintain ${best.label} form but look to increase frequency.`
            ];
            return { insights, nextSteps };
        }

        function renderRadarReport(playerName, position, pData, allPlayersData, gameName, videoId) {
            const config = positionConfig[position] || positionConfig['Midfielder'];
            
            document.getElementById('reportHeader').innerHTML = `
                <div class="flex flex-col">
                    <span class="text-3xl text-white font-bold">${playerName}</span>
                    <span class="text-lg text-cyan-400 mt-1">${position}</span>
                    <span class="text-sm text-dim mt-1">Match: ${gameName}</span>
                </div>
            `;
            
            document.getElementById('exportPdfBtn').classList.add('visible-btn');
            document.getElementById('exportPdfBtn').classList.remove('hidden-btn');

            const pMetrics = config.labels.map(lbl => {
                let t = 0, s = 0;
                config.map[lbl].forEach(term => { if(pData.actions[term]) { t += pData.actions[term].total; s += pData.actions[term].success; } });
                const pct = t > 0 ? Math.round((s/t)*100) : 0;
                return { label: lbl, total: t, succ: s, pct };
            });

            const tMetrics = config.labels.map(lbl => {
                let t = 0, s = 0;
                Object.values(allPlayersData).forEach(p => {
                    config.map[lbl].forEach(term => { if(p.actions[term]) { t += p.actions[term].total; s += p.actions[term].success; } });
                });
                return t > 0 ? Math.round((s/t)*100) : 0;
            });

            const feedback = generateFeedback(pMetrics, position);
            let videoEmbed = videoId ? `https://www.youtube.com/embed/${videoId}` : "https://www.youtube.com/embed/dQw4w9WgXcQ?mute=1";

            const container = document.getElementById('dashboardContent');
            container.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 items-center h-full mb-6">
                    <div class="lg:col-span-1 space-y-4">
                        ${pMetrics.map((m, i) => `
                            <div class="bg-gray-900/60 p-4 rounded-xl border border-gray-700 flex justify-between items-center">
                                <div><span class="text-dim font-bold uppercase text-sm block">${m.label}</span><span class="text-xs text-gray-500">Avg: ${tMetrics[i]}%</span></div>
                                <div class="text-right"><div class="space-x-1"><span class="text-xl text-white font-mono">${m.total}</span><span class="text-xs text-dim">/</span><span class="text-xl text-green-400 font-mono">${m.succ}</span></div><div class="text-xs text-cyan-400">${m.pct}%</div></div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="lg:col-span-2 bg-gray-900/40 rounded-xl border border-gray-700 p-4 flex justify-center items-center h-[400px]">
                        <div class="chart-container"><canvas id="radarChart"></canvas></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 glass-card p-0 border border-gray-700 rounded-xl overflow-hidden flex flex-col">
                        <div class="p-4 border-b border-gray-800 bg-gray-900/50"><h3 class="text-white font-bold text-lg">Video Analysis</h3></div>
                        <div class="video-container flex-grow"><iframe src="${videoEmbed}" title="Match Video" frameborder="0" allowfullscreen></iframe></div>
                    </div>
                    <div class="lg:col-span-1 glass-card p-6 border border-gray-700 rounded-xl flex flex-col gap-6">
                        <div>
                            <h3 class="text-cyan-400 font-bold uppercase tracking-wider text-sm mb-3">Coaching Insights</h3>
                            <ul class="space-y-3">${feedback.insights.map(t => `<li class="text-sm text-gray-300 flex items-start gap-2"><span class="text-accent-pink mt-1">•</span><span>${t}</span></li>`).join('')}</ul>
                        </div>
                        <div class="h-px bg-gray-700 w-full"></div>
                        <div>
                            <h3 class="text-green-400 font-bold uppercase tracking-wider text-sm mb-3">Next Steps</h3>
                            <ul class="space-y-3">${feedback.nextSteps.map(t => `<li class="text-sm text-gray-300 flex items-start gap-2"><span class="text-accent-pink mt-1">→</span><span>${t}</span></li>`).join('')}</ul>
                        </div>
                    </div>
                </div>
            `;

            const ctx = document.getElementById('radarChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: config.labels,
                    datasets: [
                        { label: 'Player', data: pMetrics.map(m => m.pct), backgroundColor: 'rgba(74, 222, 128, 0.2)', borderColor: '#4ade80', pointBackgroundColor: '#38bdf8', borderWidth: 2 },
                        { label: 'Avg', data: tMetrics, backgroundColor: 'rgba(255, 255, 255, 0.05)', borderColor: 'rgba(255, 255, 255, 0.4)', borderWidth: 1, borderDash: [5, 5] }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { r: { angleLines: { color: 'rgba(255, 255, 255, 0.1)' }, grid: { color: 'rgba(255, 255, 255, 0.1)' }, pointLabels: { color: '#cbaefc', font: { size: 14 } }, ticks: { display: false, max: 100, min: 0 } } },
                    plugins: { legend: { position: 'bottom', labels: { color: '#9ca3af' } } }
                }
            });
        }
    </script>
</body>
</html>
